[JavaScript:{ jsname: "JQuery" }]
[JavaScript:{ path: "https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"}]
[JavaScript:{ path: "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js" }]
[CSS:{ path: "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" }]
[JavaScript:{ path: "https://cdn.jsdelivr.net/npm/vue-loading-overlay@2.2.2"}]
[CSS:{ path: "https://cdn.jsdelivr.net/npm/vue-loading-overlay@2.2.2/dist/vue-loading.min.css"}]
[JavaScript:{ path: "~/Resources/Shared/scripts/dnn.jquery.js"}]
[JavaScript:{ path: "~/DesktopModules/FinHubAddOns/scripts/ServiceProviderView.js"}]
[CSS:{ path: "~/DesktopModules/FinHubAddOns/module.css"}]

[AntiForgeryToken:true]

<div id="ServiceProvider-[ModuleContext:ModuleId]">
    <service-provider-manager v-bind:module-id="moduleId"></service-provider-manager>
</div>

<script type="text/x-template" id="service-provider-template">
    <div class="sp-manager">
        <loading :active.sync="isLoading" :is-full-page="false" color="#3d87dd"></loading>
        
        <div class="sp-header">
            <h2>Service Provider Role Management</h2>
            <button type="button" @click="refreshData" class="btn-modern btn-refresh">
                <span class="refresh-icon">↻</span> Refresh
            </button>
        </div>

        <!-- Payment Statistics Section -->
        <div class="payment-statistics">
            <div class="payment-stats-header">
                <h3>Payment Overview</h3>
                <div class="year-selector">
                    <label>Year:</label>
                    <select v-model="selectedYear" @change="loadPaymentStatisticsForYear" class="year-select">
                        <option v-for="year in availableYears" :key="year" :value="year">{{year}}</option>
                    </select>
                </div>
            </div>
            <div class="payment-stat-cards">
                <div class="payment-stat-card">
                    <div class="payment-stat-value">€{{paymentStats.totalRevenue.toFixed(2)}}</div>
                    <div class="payment-stat-label">Total Revenue</div>
                </div>
                <div class="payment-stat-card">
                    <div class="payment-stat-value">€{{paymentStats.totalDiscounts.toFixed(2)}}</div>
                    <div class="payment-stat-label">Total Discounts</div>
                </div>
                <div class="payment-stat-card">
                    <div class="payment-stat-value">€{{paymentStats.revenueThisMonth.toFixed(2)}}</div>
                    <div class="payment-stat-label">This Month</div>
                </div>
                <div class="payment-stat-card">
                    <div class="payment-stat-value">€{{selectedYearRevenue.toFixed(2)}}</div>
                    <div class="payment-stat-label">{{selectedYear}} Revenue</div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="sp-statistics">
            <div class="stat-card warning clickable" @click="filterByExpiring">
                <div class="stat-number">{{expiringIn30Days}}</div>
                <div class="stat-label">Expiring in 30 days</div>
            </div>
            <div class="stat-card clickable" @click="clearFilters">
                <div class="stat-number">{{users.length}}</div>
                <div class="stat-label">Total Service Providers</div>
            </div>
            <div class="stat-card success clickable" @click="filterByPaid">
                <div class="stat-number">{{paidUsers}}</div>
                <div class="stat-label">Paid</div>
            </div>
            <div class="stat-card info clickable" @click="filterByUnpaid">
                <div class="stat-number">{{unpaidUsers}}</div>
                <div class="stat-label">Unpaid</div>
            </div>
            <div class="stat-card danger clickable" @click="filterByExpired">
                <div class="stat-number">{{expiredUsers}}</div>
                <div class="stat-label">Expired</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="sp-filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Search:</label>
                    <input v-model="filters.search" @input="applyFilters" 
                           placeholder="Name, email, username..." class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label>City:</label>
                    <select v-model="filters.city" @change="applyFilters" class="filter-select">
                        <option value="">All Cities</option>
                        <option v-for="city in uniqueCities" :key="city" :value="city">{{city}}</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>State/Region:</label>
                    <select v-model="filters.state" @change="applyFilters" class="filter-select">
                        <option value="">All States</option>
                        <option v-for="state in uniqueStates" :key="state" :value="state">{{state}}</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Country:</label>
                    <select v-model="filters.country" @change="applyFilters" class="filter-select">
                        <option value="">All Countries</option>
                        <option v-for="country in uniqueCountries" :key="country" :value="country">{{country}}</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label>Payment Status:</label>
                    <select v-model="filters.paymentStatus" @change="applyFilters" class="filter-select">
                        <option value="">All</option>
                        <option value="Paid">Paid</option>
                        <option value="Unpaid">Unpaid</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Subscription Status:</label>
                    <select v-model="filters.subscriptionStatus" @change="applyFilters" class="filter-select">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="Expiring">Expiring Soon</option>
                        <option value="Expired">Expired</option>
                    </select>
                </div>
                
                <button type="button" @click="clearFilters" class="btn-modern btn-secondary">Clear Filters</button>
            </div>
            
            <div class="filter-summary">
                Showing {{filteredUsers.length}} of {{users.length}} users
            </div>
        </div>

        <!-- Users Table -->
        <div class="sp-table-container">
            <table class="sp-table">
                <thead>
                    <tr>
                        <th @click="sortBy('DisplayName')" class="sortable">
                            Name <span class="sort-icon">{{getSortIcon('DisplayName')}}</span>
                        </th>
                        <th @click="sortBy('Email')" class="sortable">
                            Email <span class="sort-icon">{{getSortIcon('Email')}}</span>
                        </th>
                        <th>Location</th>
                        <th>Contact</th>
                        <th @click="sortBy('RoleStartDate')" class="sortable">
                            Role Start <span class="sort-icon">{{getSortIcon('RoleStartDate')}}</span>
                        </th>
                        <th @click="sortBy('SubscriptionEndDate')" class="sortable">
                            Subscription End <span class="sort-icon">{{getSortIcon('SubscriptionEndDate')}}</span>
                        </th>
                        <th @click="sortBy('PaymentStatus')" class="sortable">
                            Status <span class="sort-icon">{{getSortIcon('PaymentStatus')}}</span>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="user in paginatedUsers" :key="user.UserId" :class="getRowClass(user)">
                        <td>
                            <strong>{{user.DisplayName}}</strong>
                            <div class="sub-text">{{user.FirstName}} {{user.LastName}}</div>
                        </td>
                        <td>
                            <a :href="'mailto:' + user.Email">{{user.Email}}</a>
                        </td>
                        <td>
                            <div v-if="user.City || user.StateRegion || user.Country">
                                {{user.City}}<span v-if="user.City && user.StateRegion">, </span>{{user.StateRegion}}
                                <div v-if="user.Country" class="sub-text">{{user.Country}}</div>
                            </div>
                            <span v-else class="no-data">-</span>
                        </td>
                        <td>
                            <div v-if="user.Phone">📞 {{user.Phone}}</div>
                            <div v-if="user.Mobile">📱 {{user.Mobile}}</div>
                            <span v-if="!user.Phone && !user.Mobile" class="no-data">-</span>
                        </td>
                        <td>{{formatDate(user.RoleStartDate)}}</td>
                        <td>
                            <div v-if="editingExpiration === user.UserId" class="expiration-edit">
                                <input type="date" v-model="newExpirationDate" class="date-input">
                                <button type="button" @click="saveExpiration(user)" class="btn-save" title="Save">✓</button>
                                <button type="button" @click="cancelExpiration" class="btn-cancel" title="Cancel">✗</button>
                            </div>
                            <div v-else @click="startEditExpiration(user)" class="editable-date" :class="getSubscriptionClass(user)">
                                {{formatExpiration(user.RoleExpirationDate)}}
                                <span class="edit-icon">✏️</span>
                                <div v-if="user.CurrentPlan" class="sub-text">{{user.CurrentPlan}}</div>
                            </div>
                        </td>
                        <td>
                            <span :class="['status-badge', getStatusClass(user)]">
                                {{getStatus(user)}}
                            </span>
                        </td>
                        <td>
                            <div class="action-dropdown">
                                <button type="button" @click="toggleActionMenu(user.UserId)" class="action-dots">⋮</button>
                                <div v-if="actionMenuOpen === user.UserId" class="action-menu">
                                    <a @click="editUser(user)" class="action-item">
                                        <span class="action-icon">✏️</span> Edit User
                                    </a>
                                    <a @click="insertPayment(user)" class="action-item">
                                        <span class="action-icon">💳</span> Insert Payment
                                    </a>
                                    <a @click="viewPaymentHistory(user)" class="action-item">
                                        <span class="action-icon">📜</span> Payment History
                                    </a>
                                    <a @click="confirmRemoveUser(user)" class="action-item danger">
                                        <span class="action-icon">🗑️</span> Remove from Role
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div v-if="totalPages > 1" class="sp-pagination">
            <button type="button" @click="currentPage = 1" :disabled="currentPage === 1" class="page-btn">«</button>
            <button type="button" @click="currentPage--" :disabled="currentPage === 1" class="page-btn">‹</button>
            
            <span class="page-info">Page {{currentPage}} of {{totalPages}}</span>
            
            <button type="button" @click="currentPage++" :disabled="currentPage === totalPages" class="page-btn">›</button>
            <button type="button" @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="page-btn">»</button>
            
            <select v-model="pageSize" @change="currentPage = 1" class="page-size">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>

        <!-- Edit User Modal -->
        <div v-if="editingUser" class="modal-overlay" @click="cancelEdit">
            <div class="modal-content modal-edit" @click.stop>
                <div class="modal-header">
                    <h3>Edit User: {{editingUser.DisplayName}}</h3>
                    <button type="button" class="modal-close" @click="cancelEdit">×</button>
                </div>
                
                <div class="modal-body">
                    <div class="edit-form">
                        <!-- Account Information -->
                        <h4>Account Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" :value="editingUser.Username" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label>User ID</label>
                                <input type="text" :value="editingUser.UserId" class="form-control" disabled>
                            </div>
                        </div>

                        <!-- Basic Information -->
                        <h4>Basic Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" v-model="editForm.firstName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" v-model="editForm.lastName" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" v-model="editForm.displayName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" v-model="editForm.email" class="form-control">
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <h4>Contact Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" v-model="editForm.phone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Mobile</label>
                                <input type="tel" v-model="editForm.mobile" class="form-control">
                            </div>
                        </div>

                        <!-- Address Information -->
                        <h4>Address Information</h4>
                        <div class="form-group full-width">
                            <label>Street Address</label>
                            <input type="text" v-model="editForm.street" class="form-control">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" v-model="editForm.city" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>State/Region</label>
                                <input type="text" v-model="editForm.stateRegion" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Postal Code</label>
                                <input type="text" v-model="editForm.postalCode" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" v-model="editForm.country" class="form-control">
                            </div>
                        </div>

                        <!-- Role Information -->
                        <h4>Role Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Role Start Date</label>
                                <input type="text" :value="formatDate(editingUser.RoleStartDate)" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label>Role Expiration Date</label>
                                <input type="date" v-model="editForm.roleExpirationDate" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Current Payment Status</label>
                                <input type="text" :value="editingUser.PaymentStatus" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label>Current Plan</label>
                                <input type="text" :value="editingUser.CurrentPlan || 'None'" class="form-control" disabled>
                            </div>
                        </div>

                        <!-- Account Status -->
                        <h4>Account Status</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" v-model="editForm.isAuthorized" class="form-checkbox">
                                    <span>User is Authorized</span>
                                </label>
                                <div class="form-help">Unauthorized users cannot access the portal</div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label danger">
                                    <input type="checkbox" v-model="editForm.isDeleted" class="form-checkbox">
                                    <span>Soft Delete User</span>
                                </label>
                                <div class="form-help danger">User will be marked as deleted but data retained</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" @click="saveUserEdit" class="btn-modern btn-primary">Save Changes</button>
                    <button type="button" @click="cancelEdit" class="btn-modern btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div v-if="showConfirmModal" class="modal-overlay" @click="cancelRemove">
            <div class="modal-content" @click.stop>
                <h3>Confirm Removal</h3>
                <p>Are you sure you want to remove <strong>{{userToRemove.DisplayName}}</strong> from the Service Provider role?</p>
                <div class="modal-actions">
                    <button type="button" @click="removeUser" class="btn-modern btn-danger">Yes, Remove</button>
                    <button type="button" @click="cancelRemove" class="btn-modern btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div v-if="showPaymentModal" class="modal-overlay" @click="cancelPayment">
            <div class="modal-content modal-payment" @click.stop>
                <div class="modal-header">
                    <h3>Record Payment for {{paymentForm.userName}}</h3>
                    <button type="button" class="modal-close" @click="cancelPayment">×</button>
                </div>
                
                <div class="modal-body">
                    <!-- Subscription Plans -->
                    <h4>Select Subscription Plan</h4>
                    <div class="plan-grid">
                        <div v-for="plan in subscriptionPlans" :key="plan.PlanID" 
                             @click="selectPlan(plan)"
                             :class="['plan-card', { 'selected': paymentForm.planId === plan.PlanID }]">
                            <div class="plan-name">{{plan.PlanName}}</div>
                            <div class="plan-amount">€{{plan.Amount}}</div>
                            <div class="plan-duration">{{plan.DurationMonths}} months</div>
                            <div v-if="plan.Description" class="plan-description">{{plan.Description}}</div>
                        </div>
                    </div>

                    <!-- Payment Details -->
                    <h4>Payment Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Date</label>
                            <input type="date" v-model="paymentForm.paymentDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select v-model="paymentForm.paymentMethod" class="form-control">
                                <option value="BankTransfer">Bank Transfer</option>
                                <option value="Cash">Cash</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Reference Number <span class="required">*</span></label>
                            <input type="text" v-model="paymentForm.referenceNumber" class="form-control" 
                                   placeholder="Transaction ID or receipt number">
                        </div>
                        <div class="form-group">
                            <label>Plan Amount (€)</label>
                            <input type="number" v-model="paymentForm.amount" class="form-control" 
                                   :disabled="paymentForm.planId !== null" step="0.01" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Discount (€)</label>
                            <input type="number" v-model="paymentForm.discountAmount" 
                                   @input="calculateAmountPaid" class="form-control" 
                                   step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>Amount Paid (€)</label>
                            <input type="number" v-model="paymentForm.amountPaid" class="form-control" 
                                   step="0.01" readonly style="font-weight: bold; background-color: #f0f8ff;">
                        </div>
                    </div>

                    <!-- Subscription Period -->
                    <h4>Subscription Period</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" v-model="paymentForm.subscriptionStartDate" 
                                   @change="paymentForm.planId && selectPlan(subscriptionPlans.find(p => p.PlanID === paymentForm.planId))"
                                   class="form-control">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" v-model="paymentForm.subscriptionEndDate" 
                                   class="form-control" :disabled="!paymentForm.planId">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label>Notes</label>
                        <textarea v-model="paymentForm.notes" class="form-control" rows="3" 
                                  placeholder="Additional notes about this payment"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" @click="savePayment" class="btn-modern btn-primary">Record Payment</button>
                    <button type="button" @click="cancelPayment" class="btn-modern btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Payment History Modal -->
        <div v-if="showPaymentHistoryModal" class="modal-overlay" @click="closePaymentHistory">
            <div class="modal-content modal-history" @click.stop>
                <div class="modal-header">
                    <h3>Payment History - {{viewingPaymentHistoryUser ? viewingPaymentHistoryUser.DisplayName : ''}}</h3>
                    <button type="button" class="modal-close" @click="closePaymentHistory">×</button>
                </div>
                
                <div class="modal-body">
                    <div v-if="paymentHistory.length === 0" class="no-payments">
                        No payments recorded for this user.
                    </div>
                    
                    <div v-else class="payment-history-table">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Plan</th>
                                    <th>Amount</th>
                                    <th>Discount</th>
                                    <th>Paid</th>
                                    <th>Period</th>
                                    <th>Method</th>
                                    <th>Ref</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="payment in paymentHistory" :key="payment.PaymentID">
                                    <td>{{formatDate(payment.PaymentDate)}}</td>
                                    <td>{{payment.PlanName || '-'}}</td>
                                    <td>€{{payment.Amount}}</td>
                                    <td>€{{payment.DiscountAmount || 0}}</td>
                                    <td style="font-weight: bold;">€{{(payment.Amount - (payment.DiscountAmount || 0)).toFixed(2)}}</td>
                                    <td>
                                        <div v-if="payment.SubscriptionStartDate && payment.SubscriptionEndDate">
                                            {{formatDate(payment.SubscriptionStartDate)}} - {{formatDate(payment.SubscriptionEndDate)}}
                                        </div>
                                        <span v-else>-</span>
                                    </td>
                                    <td>{{payment.PaymentMethod || '-'}}</td>
                                    <td>{{payment.ReferenceNumber || '-'}}</td>
                                    <td>
                                        <span :class="['payment-status', getPaymentStatusClass(payment.Status)]">
                                            {{payment.Status}}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" @click="closePaymentHistory" class="btn-modern btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>
</script>

<script language="javascript" type="text/javascript">
    jQuery(function () {
        var moduleId = parseInt("[ModuleContext:ModuleId]");

        new Vue({
            data: {
                moduleId: moduleId
            },
            el: "#ServiceProvider-" + moduleId,
            components: {
                "service-provider-manager": FinHubAddOns.ServiceProviderComponent
            }
        });

        // Close action menus when clicking outside
        jQuery(document).on('click', function (e) {
            if (!jQuery(e.target).closest('.action-dropdown').length) {
                var vm = Vue.prototype._vueInstances && Vue.prototype._vueInstances[0];
                if (vm && vm.$children[0]) {
                    vm.$children[0].actionMenuOpen = null;
                }
            }
        });
    });
</script>