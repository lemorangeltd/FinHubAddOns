[JavaScript:{ jsname: "JQuery" }]
[JavaScript:{ path: "https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"}]
[JavaScript:{ path: "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js" }]
[CSS:{ path: "https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" }]
[JavaScript:{ path: "https://cdn.jsdelivr.net/npm/vue-loading-overlay@2.2.2"}]
[CSS:{ path: "https://cdn.jsdelivr.net/npm/vue-loading-overlay@2.2.2/dist/vue-loading.min.css"}]
[JavaScript:{ path: "~/Resources/Shared/scripts/dnn.jquery.js"}]
[JavaScript:{ path: "~/DesktopModules/FinHubAddOns/Scripts/ServiceProviderView.js"}]
[CSS:{ path: "~/DesktopModules/FinHubAddOns/module.css"}]

[AntiForgeryToken:true]

<div id="ServiceProvider-[ModuleContext:ModuleId]">
    <service-provider-manager v-bind:module-id="moduleId"></service-provider-manager>
</div>

<script type="text/x-template" id="service-provider-template">
    <div class="sp-manager">
        <loading :active.sync="isLoading" :is-full-page="false" color="#3d87dd"></loading>
        
        <div class="sp-header">
            <h2>Service Provider Role Management</h2>
            <button type="button" @click="refreshData" class="btn-modern btn-refresh">
                <span class="refresh-icon">↻</span> Refresh
            </button>
        </div>

        <!-- Payment Statistics Section -->
        <div class="payment-statistics">
            <div class="payment-stats-header">
                <h3>Payment Overview</h3>               
            </div>
            <div class="payment-stat-cards">
                <div class="payment-stat-card has-tooltip"
                     @mouseenter="showTooltip($event, 'Total revenue generated from all SP payments. Indicates overall business performance and growth direction.')"
                     @mouseleave="hideTooltip">
                    <div class="payment-stat-value">{{formatCurrency(paymentStats.totalRevenue)}}</div>
                    <div class="payment-stat-label">Total Revenue <i class="info-icon">ℹ</i></div>
                </div>
                <div class="payment-stat-card has-tooltip"
                     @mouseenter="showTooltip($event, 'Total amount of discounts given to customers.')"
                     @mouseleave="hideTooltip">
                    <div class="payment-stat-value">{{formatCurrency(paymentStats.totalDiscounts)}}</div>
                    <div class="payment-stat-label">Total Discounts <i class="info-icon">ℹ</i></div>
                </div>
                <div class="payment-stat-card has-tooltip"
                     @mouseenter="showTooltip($event, 'Revenue generated this month.')"
                     @mouseleave="hideTooltip">
                    <div class="payment-stat-value">{{formatCurrency(paymentStats.revenueThisMonth)}}</div>
                    <div class="payment-stat-label">This Month <i class="info-icon">ℹ</i></div>
                </div>
                <div class="payment-stat-card has-tooltip"
                     @mouseenter="showTooltip($event, 'Revenue for the selected year.')"
                     @mouseleave="hideTooltip">
                    <div class="payment-stat-value">{{formatCurrency(selectedYearRevenue)}}</div>
                    <div class="payment-stat-label">
                        <select v-model="selectedYear" @change="loadPaymentStatisticsForYear" class="year-select">
                            <option v-for="year in availableYears" :key="year" :value="year">{{year}}</option>
                        </select>
                        Revenue <i class="info-icon">ℹ</i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Statistics Section with New 5-Status System -->
        <div class="sp-statistics">
            <!-- Trial Users -->
            <div class="stat-card info clickable has-tooltip" @click="filterByTrial" 
                 @mouseenter="showTooltip($event, 'Users in their first 48 hours who never paid. Prime time for nurturing and conversion!')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{trialUsers}}</div>
                <div class="stat-label">Trial <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Active Users -->
            <div class="stat-card success clickable has-tooltip" @click="filterByActive"
                 @mouseenter="showTooltip($event, 'Users with active paid subscriptions. Your current revenue base - keep them happy!')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{activeUsers}}</div>
                <div class="stat-label">Active ({{paidPercentage}}%) <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Active + Unpaid -->
            <div class="stat-card warning clickable has-tooltip" @click="filterByActiveUnpaid"
                 @mouseenter="showTooltip($event, 'Subscription dates are valid but no payment received. Could be grace period or payment issue. URGENT PAYMENT FOLLOW-UP REQUIRED!')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{activeUnpaidUsers}}</div>
                <div class="stat-label">Active + Unpaid <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Expiring Soon -->
            <div class="stat-card danger clickable has-tooltip" @click="filterByExpiring"
                 @mouseenter="showTooltip($event, 'Active users whose subscriptions expire within 30 days. Requires IMMEDIATE retention action!')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{expiringIn30Days}}</div>
                <div class="stat-label">Expiring Soon <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Expired + Never Paid -->
            <div class="stat-card warning clickable has-tooltip" @click="filterByExpiredNeverPaid"
                 @mouseenter="showTooltip($event, 'Subscription ended and never made a payment. CONVERSION CAMPAIGN targets!')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{expiredNeverPaidUsers}}</div>
                <div class="stat-label">Expired + Never Paid <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Lapsed Users -->
            <div class="stat-card danger clickable has-tooltip" @click="filterByLapsed"
                 @mouseenter="showTooltip($event, 'Had active subscription before but did not renew. WIN-BACK OPPORTUNITY!')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{lapsedUsers}}</div>
                <div class="stat-label">Lapsed <i class="info-icon">ℹ</i></div>
            </div>
        </div>

        <!-- Additional KPI Cards Row -->
        <div class="sp-statistics">
            <!-- New Registrations This Month -->
            <div class="stat-card info clickable has-tooltip" @click="filterByNewRegistrations" 
                 @mouseenter="showTooltip($event, 'Number of service providers who registered this month. Growth indicator.')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{newRegistrationsThisMonth}}</div>
                <div class="stat-label">New This Month <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Total Users -->
            <div class="stat-card clickable has-tooltip" @click="clearFilters"
                 @mouseenter="showTooltip($event, 'Total number of service providers in FinHub (all statuses combined).')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{users.length}}</div>
                <div class="stat-label">Total Users <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Average Revenue Per User -->
            <div class="stat-card success has-tooltip"
                 @mouseenter="showTooltip($event, 'Average Revenue generated per active paying customer. Higher ARPU indicates better pricing and value delivery.')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{formatCurrency(averageRevenuePerUser)}}</div>
                <div class="stat-label">Avg Revenue/User <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Conversion Rate -->
            <div class="stat-card info has-tooltip"
                 @mouseenter="showTooltip($event, 'Percentage of users who eventually made at least one payment. Indicates sales effectiveness.')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{conversionRate}}%</div>
                <div class="stat-label">Ever-Paid Rate <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Geographic Distribution -->
            <div class="stat-card clickable has-tooltip" @click="showGeographicBreakdown = !showGeographicBreakdown"
                 @mouseenter="showTooltip($event, 'Number of different countries represented in your user base.')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{topCountriesCount}}</div>
                <div class="stat-label">Countries <i class="info-icon">ℹ</i></div>
            </div>
            
            <!-- Monthly Recurring Revenue -->
            <div class="stat-card success has-tooltip"
                 @mouseenter="showTooltip($event, 'Estimated monthly recurring revenue from active subscriptions. Key business health metric.')"
                 @mouseleave="hideTooltip">
                <div class="stat-number">{{formatCurrency(monthlyRecurringRevenue)}}</div>
                <div class="stat-label">Est. MRR <i class="info-icon">ℹ</i></div>
            </div>
        </div>

        <!-- Geographic Breakdown (Collapsible) -->
        <div v-if="showGeographicBreakdown" class="geographic-breakdown">
            <h4>Geographic Distribution</h4>
            <div class="geo-stats">
                <div v-for="country in topCountries" :key="country.name" class="geo-item">
                    <span class="geo-country">{{country.name}}</span>
                    <span class="geo-count">{{country.count}} users</span>
                    <span class="geo-percentage">({{country.percentage}}%)</span>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="sp-filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Search:</label>
                    <input v-model="filters.search" @input="applyFilters" 
                           placeholder="Name, email, username..." class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label>Registration Date:</label>
                    <div class="registration-period-buttons">
                        <button type="button" 
                                @click="setRegistrationPeriod('')" 
                                :class="['period-btn', { 'active': filters.registrationPeriod === '' }]">
                            All Time
                        </button>
                        <button type="button" 
                                @click="setRegistrationPeriod('last7days')" 
                                :class="['period-btn', { 'active': filters.registrationPeriod === 'last7days' }]">
                            7d
                        </button>
                        <button type="button" 
                                @click="setRegistrationPeriod('last30days')" 
                                :class="['period-btn', { 'active': filters.registrationPeriod === 'last30days' }]">
                            30d
                        </button>
                        <button type="button" 
                                @click="setRegistrationPeriod('last90days')" 
                                :class="['period-btn', { 'active': filters.registrationPeriod === 'last90days' }]">
                            90d
                        </button>
                        <button type="button" 
                                @click="setRegistrationPeriod('thisyear')" 
                                :class="['period-btn', { 'active': filters.registrationPeriod === 'thisyear' }]">
                            This Year
                        </button>
                        <button type="button" 
                                @click="setRegistrationPeriod('lastyear')" 
                                :class="['period-btn', { 'active': filters.registrationPeriod === 'lastyear' }]">
                            Last Year
                        </button>
                        <button type="button" 
                                @click="setRegistrationPeriod('last2years')" 
                                :class="['period-btn', { 'active': filters.registrationPeriod === 'last2years' }]">
                            2y
                        </button>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>User Status:</label>
                    <div class="status-filter-buttons">
                        <button type="button" 
                                @click="setUserStatus('')" 
                                :class="['status-btn', { 'active': filters.userStatus === '' }]">
                            All
                        </button>
                        <button type="button" 
                                @click="setUserStatus('Trial')" 
                                :class="['status-btn', 'status-btn-info', { 'active': filters.userStatus === 'Trial' }]">
                            Trial
                        </button>
                        <button type="button" 
                                @click="setUserStatus('Active')" 
                                :class="['status-btn', 'status-btn-success', { 'active': filters.userStatus === 'Active' }]">
                            Active
                        </button>
                        <button type="button" 
                                @click="setUserStatus('Active + Unpaid')" 
                                :class="['status-btn', 'status-btn-success', { 'active': filters.userStatus === 'Active + Unpaid' }]">
                            Active + Unpaid
                        </button>
                        <button type="button" 
                                @click="setUserStatus('Expired + Never Paid')" 
                                :class="['status-btn', 'status-btn-warning', { 'active': filters.userStatus === 'Expired + Never Paid' }]">
                            Expired + Never Paid
                        </button>
                        <button type="button" 
                                @click="setUserStatus('Lapsed')" 
                                :class="['status-btn', 'status-btn-danger', { 'active': filters.userStatus === 'Lapsed' }]">
                            Lapsed
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label>City:</label>
                    <select v-model="filters.city" @change="applyFilters" class="filter-select">
                        <option value="">All Cities</option>
                        <option v-for="city in uniqueCities" :key="city" :value="city">{{city}}</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>State/Region:</label>
                    <select v-model="filters.state" @change="applyFilters" class="filter-select">
                        <option value="">All States</option>
                        <option v-for="state in uniqueStates" :key="state" :value="state">{{state}}</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Country:</label>
                    <select v-model="filters.country" @change="applyFilters" class="filter-select">
                        <option value="">All Countries</option>
                        <option v-for="country in uniqueCountries" :key="country" :value="country">{{country}}</option>
                    </select>
                </div>

                <div class="filter-group">
                     <label class="checkbox-label">
                            <input type="checkbox" 
                                   v-model="filters.hideDeleted" 
                                   @change="applyFilters"
                                   class="filter-checkbox">
                          <span>Hide deleted SPs</span>
                     </label>
                </div>
            </div>
            
            <div class="filter-row">
                <button type="button" @click="clearFilters" class="btn-modern btn-secondary">Clear Filters</button>
            </div>
            
            <div class="filter-summary">
                Showing {{filteredUsers.length}} of {{users.length}} Service Providers
                <span v-if="filters.registrationPeriod" class="filter-active-indicator">
                    (Filtered by: {{getRegistrationPeriodLabel(filters.registrationPeriod)}})
                </span>
                <span v-if="filters.userStatus" class="filter-active-indicator">
                    (Status: {{filters.userStatus}})
                </span>
            </div>
        </div>

        <!-- Users Table -->
        <div class="sp-table-container">
            <div class="table-header-info">
                <span class="table-instruction">💡 <strong>Tip:</strong> Double-click any row to view detailed profile, or use the ⋮ menu for quick actions</span>
            </div>
            <table class="sp-table">
                <thead>
                    <tr>
                        <th @click="sortBy('DisplayName')" class="sortable">
                            Name <span class="sort-icon">{{getSortIcon('DisplayName')}}</span>
                        </th>
                        <th @click="sortBy('Email')" class="sortable">
                            Email <span class="sort-icon">{{getSortIcon('Email')}}</span>
                        </th>
                        <th>Location</th>
                        <th>Contact</th>
                        <th @click="sortBy('RoleStartDate')" class="sortable">
                            Role Start <span class="sort-icon">{{getSortIcon('RoleStartDate')}}</span>
                        </th>
                        <th @click="sortBy('SubscriptionEndDate')" class="sortable">
                            Subscription End <span class="sort-icon">{{getSortIcon('SubscriptionEndDate')}}</span>
                        </th>
                        <th @click="sortBy('PaymentStatus')" class="sortable">
                            Status <span class="sort-icon">{{getSortIcon('PaymentStatus')}}</span>
                        </th>
                        <th @click="sortBy('AverageRating')" class="sortable">
                            Rating <span class="sort-icon">{{getSortIcon('AverageRating')}}</span>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="user in paginatedUsers" :key="user.UserId" :class="getRowClass(user)" @dblclick="viewProfile(user)">
                        <td>
                            <div class="user-info">
                                <strong>{{user.DisplayName}}</strong>
                                <span v-if="isExpiringWithin30Days(user)" class="expiring-indicator" title="Expiring within 30 days!">⚠️</span>
                            </div>
                            <div class="sub-text">{{user.FirstName}} {{user.LastName}}</div>
                        </td>
                        <td>
                            <a :href="'mailto:' + user.Email">{{user.Email}}</a>
                        </td>
                        <td>
                            <div v-if="user.City || user.StateRegion || user.Country">
                                {{user.City}}<span v-if="user.City && user.StateRegion">, </span>{{user.StateRegion}}
                                <div v-if="user.Country" class="sub-text">{{user.Country}}</div>
                            </div>
                            <span v-else class="no-data">-</span>
                        </td>
                        <td>
                            <div v-if="user.Phone">📞 {{user.Phone}}</div>
                            <div v-if="user.Mobile">📱 {{user.Mobile}}</div>
                            <span v-if="!user.Phone && !user.Mobile" class="no-data">-</span>
                        </td>
                        <td>{{formatDate(user.RoleStartDate)}}</td>
                        <td>
                            <div v-if="editingExpiration === user.UserId" class="expiration-edit">
                                <input type="date" v-model="newExpirationDate" class="date-input">
                                <button type="button" @click="saveExpiration(user)" class="btn-save" title="Save">✓</button>
                                <button type="button" @click="cancelExpiration" class="btn-cancel" title="Cancel">✗</button>
                            </div>
                            <div v-else @click="startEditExpiration(user)" class="editable-date" :class="getSubscriptionClass(user)">
                                {{formatExpiration(user.RoleExpirationDate)}}
                                <span class="edit-icon">✏️</span>
                                <div v-if="user.CurrentPlan" class="sub-text">{{user.CurrentPlan}}</div>
                            </div>
                        </td>
                        <td>
                            <span :class="['status-badge', getStatusClass(user)]"
                                  :title="getStatusTooltip(user)">
                                {{getStatus(user)}}
                            </span>
                            <span v-if="user.IsDeleted" class="user-icon deleted-icon" title="User is soft deleted">🗑️</span>
                            <span v-if="!user.IsAuthorized" class="user-icon unauthorized-icon" title="User is unauthorized">🚫</span>
                        </td>
                        <td>
                            <div v-if="user.AverageRating > 0" class="rating-display">
                                <span class="rating-stars">{{formatRatingStars(Math.round(user.AverageRating))}}</span>
                                <span class="rating-value">({{user.AverageRating.toFixed(1)}})</span>
                            </div>
                            <span v-else class="no-data">No rating</span>
                        </td>
                        <td>
                            <div class="action-dropdown">
                                <button type="button" 
                                        @click="toggleActionMenu(user.UserId)" 
                                        class="action-dots"
                                        :data-userid="user.UserId">⋮</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div v-if="totalPages > 1" class="sp-pagination">
            <button type="button" @click="currentPage = 1" :disabled="currentPage === 1" class="page-btn">«</button>
            <button type="button" @click="currentPage--" :disabled="currentPage === 1" class="page-btn">‹</button>
            
            <span class="page-info">Page {{currentPage}} of {{totalPages}}</span>
            
            <button type="button" @click="currentPage++" :disabled="currentPage === totalPages" class="page-btn">›</button>
            <button type="button" @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="page-btn">»</button>
            
            <select v-model="pageSize" @change="currentPage = 1" class="page-size">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>

        <!-- Enhanced Service Provider Profile Panel - COMPLETELY REDESIGNED -->
        <div v-if="showProfilePanel" class="profile-panel-backdrop" @click="closeProfile">
            <div class="profile-panel-wide" @click.stop>
                <!-- Profile Header with User Info -->
                <div class="profile-header-wide">
                    <div class="profile-header-left">
                        <div class="profile-avatar">
                            <span class="avatar-initials">{{getInitials(selectedProfile.DisplayName)}}</span>
                        </div>
                        <div class="profile-basic-info">
                            <h1>{{selectedProfile.DisplayName}}</h1>
                            <div class="profile-subtitle">{{selectedProfile.Email}}</div>
                            <div class="profile-contact-quick">
                                <span v-if="selectedProfile.Phone" class="contact-item">📞 {{selectedProfile.Phone}}</span>
                                <span v-if="selectedProfile.Mobile" class="contact-item">📱 {{selectedProfile.Mobile}}</span>
                            </div>
                            <div class="profile-status-badge">
                                <span :class="['status-badge-large', getStatusClass(selectedProfile)]">
                                    {{getStatus(selectedProfile)}}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-header-right">
                        <div class="profile-quick-stats">
                            <div class="quick-stat">
                                <div class="quick-stat-number">{{selectedProfile.DaysInRole || 0}}</div>
                                <div class="quick-stat-label">Days Active</div>
                            </div>
                            <div class="quick-stat" v-if="selectedProfile.AverageRating > 0">
                                <div class="quick-stat-number">{{selectedProfile.AverageRating.toFixed(1)}}</div>
                                <div class="quick-stat-label">Rating</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-number">{{formatDate(selectedProfile.RoleStartDate)}}</div>
                                <div class="quick-stat-label">Joined</div>
                            </div>
                        </div>
                        <button type="button" class="profile-close-wide" @click="closeProfile">×</button>
                    </div>
                </div>

                <!-- Profile Navigation with Counts - UPDATED -->
                <div class="profile-nav">
                    <button type="button" 
                            @click="activeProfileTab = 'overview'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'overview' }]">
                        <span class="nav-icon">📊</span>
                        Overview
                    </button>
                    <button type="button" 
                            @click="activeProfileTab = 'timeline'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'timeline' }]">
                        <span class="nav-icon">📝</span>
                        Timeline ({{profileData.actions.length}})
                    </button>
                    <button type="button" 
                            @click="activeProfileTab = 'tasks'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'tasks' }]">
                        <span class="nav-icon">📋</span>
                        Tasks ({{profileData.tasks.length}})
                    </button>
                    <button type="button" 
                            @click="activeProfileTab = 'projects'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'projects' }]">
                        <span class="nav-icon">💼</span>
                        Projects ({{profileData.projects.length}})
                    </button>
                    <button type="button" 
                            @click="activeProfileTab = 'ratings'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'ratings' }]">
                        <span class="nav-icon">⭐</span>
                        Ratings ({{profileData.ratings.length}})
                    </button>
                    <button type="button" 
                            @click="activeProfileTab = 'profile'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'profile' }]">
                        <span class="nav-icon">👤</span>
                        Profile Data
                    </button>
                    <!-- NEW TABS -->
                    <button type="button" 
                            @click="activeProfileTab = 'edit'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'edit' }]">
                        <span class="nav-icon">✏️</span>
                        Edit Profile
                    </button>
                    <button type="button" 
                            @click="activeProfileTab = 'payments'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'payments' }]">
                        <span class="nav-icon">💳</span>
                        Record Payment
                    </button>
                    <button type="button" 
                            @click="activeProfileTab = 'payment-history'" 
                            :class="['profile-nav-btn', { 'active': activeProfileTab === 'payment-history' }]">
                        <span class="nav-icon">📜</span>
                        Payment History ({{paymentHistory.length}})
                    </button>
                </div>

                <!-- Profile Content Area -->
                <div class="profile-content-wide">
                    <!-- Overview Tab -->
                    <div v-if="activeProfileTab === 'overview'" class="profile-tab-panel">
                        <div class="overview-grid">
                            <!-- Performance Stats -->
                            <div class="overview-section">
                                <h3>Performance Overview</h3>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-value">{{getTotalProjects()}}</div>
                                        <div class="stat-label">Total Projects</div>
                                    </div>
                                    <div class="stat-item success">
                                        <div class="stat-value">{{getAwardedProjects()}}</div>
                                        <div class="stat-label">Awarded</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">{{getPendingProjects()}}</div>
                                        <div class="stat-label">Pending</div>
                                    </div>
                                    <div class="stat-item danger">
                                        <div class="stat-value">{{getRejectedProjects()}}</div>
                                        <div class="stat-label">Rejected</div>
                                    </div>
                                </div>
                                <div class="revenue-stats">
                                    <div class="revenue-item">
                                        <div class="revenue-value">{{formatCurrency(getTotalProjectValue())}}</div>
                                        <div class="revenue-label">Total Project Value</div>
                                    </div>
                                    <div class="revenue-item">
                                        <div class="revenue-value">{{formatCurrency(getAverageProjectValue())}}</div>
                                        <div class="revenue-label">Avg Project Value</div>
                                    </div>
                                    <div class="revenue-item">
                                        <div class="revenue-value">{{getSuccessRate()}}%</div>
                                        <div class="revenue-label">Success Rate</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Information -->
                            <div class="overview-section">
                                <h3>Account Status</h3>
                                <div class="account-details">
                                    <div class="detail-row">
                                        <label>Current Status:</label>
                                        <span :class="['status-badge', getStatusClass(selectedProfile)]">
                                            {{getStatus(selectedProfile)}}
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <label>Role Start:</label>
                                        <span>{{formatDate(selectedProfile.RoleStartDate)}}</span>
                                    </div>
                                    <div class="detail-row">
                                        <label>Role Expiration:</label>
                                        <span :class="getSubscriptionClass(selectedProfile)">
                                            {{formatExpiration(selectedProfile.RoleExpirationDate)}}
                                        </span>
                                    </div>
                                    <div class="detail-row" v-if="selectedProfile.CurrentPlan">
                                        <label>Current Plan:</label>
                                        <span>{{selectedProfile.CurrentPlan}}</span>
                                    </div>
                                    <div class="detail-row" v-if="selectedProfile.SubscriptionEndDate">
                                        <label>Subscription End:</label>
                                        <span>{{formatDate(selectedProfile.SubscriptionEndDate)}}</span>
                                    </div>
                                    <div class="detail-row">
                                        <label>Authorization:</label>
                                        <span :class="selectedProfile.IsAuthorized ? 'status-authorized' : 'status-unauthorized'">
                                            {{selectedProfile.IsAuthorized ? 'Authorized' : 'Unauthorized'}}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="overview-section recent-activity">
                                <h3>Recent Activity</h3>
                                <div v-if="profileData.actions.length === 0" class="no-activity">
                                    No recent activity
                                </div>
                                <div v-else class="activity-list">
                                    <div v-for="action in profileData.actions.slice(0, 5)" :key="action.ActionID" class="activity-item">
                                        <div class="activity-icon">{{getActionIcon(action.ActionType)}}</div>
                                        <div class="activity-content">
                                            <div class="activity-title">{{action.ActionTitle}}</div>
                                            <div class="activity-meta">{{formatDate(action.ActionDate)}} • {{action.CreatedByName}}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div v-if="activeProfileTab === 'timeline'" class="profile-tab-panel">
                        <div class="tab-actions">
                            <button type="button" @click="toggleActionForm" class="btn-modern btn-primary">
                                <span class="action-icon">📝</span> Add Note/Action
                            </button>
                        </div>

                        <!-- Action Form -->
                        <div v-if="showActionForm" class="form-section">
                            <h4>Add Note/Action</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Action Type</label>
                                    <select v-model="actionForm.actionType" class="form-control">
                                        <option value="Note">Note</option>
                                        <option value="Call">Call</option>
                                        <option value="Email">Email</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Task">Task</option>
                                        <option value="StatusChange">Status Change</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select v-model="actionForm.priority" class="form-control">
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" v-model="actionForm.actionDate" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Title <span class="required">*</span></label>
                                <input type="text" v-model="actionForm.actionTitle" class="form-control" placeholder="Brief title for this action">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea v-model="actionForm.actionDescription" class="form-control" rows="3" placeholder="Detailed description"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" v-model="actionForm.isPrivate" class="form-checkbox">
                                    <span>Private (only visible to me)</span>
                                </label>
                            </div>
                            <div class="form-actions">
                                <button type="button" @click="saveAction" class="btn-modern btn-primary">Save Action</button>
                                <button type="button" @click="toggleActionForm" class="btn-modern btn-secondary">Cancel</button>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div v-if="profileData.actions.length === 0" class="empty-state">
                            <div class="empty-icon">📝</div>
                            <h4>No Actions Yet</h4>
                            <p>Start tracking interactions with this service provider by adding your first note or action.</p>
                        </div>
                        <div v-else class="timeline-container">
                            <div v-for="action in profileData.actions" :key="action.ActionID" class="timeline-item-wide">
                                <div class="timeline-marker">{{getActionIcon(action.ActionType)}}</div>
                                <div class="timeline-content-wide">
                                    <div class="timeline-header-wide">
                                        <h5>{{action.ActionTitle}}</h5>
                                        <div class="timeline-badges">
                                            <span v-if="action.Priority" :class="['priority-badge', getPriorityClass(action.Priority)]">
                                                {{action.Priority}}
                                            </span>
                                            <span v-if="action.IsPrivate" class="private-badge">Private</span>
                                        </div>
                                    </div>
                                    <p v-if="action.ActionDescription" class="timeline-description">{{action.ActionDescription}}</p>
                                    <div class="timeline-meta-wide">
                                        <span class="timeline-date">{{formatDate(action.ActionDate)}}</span>
                                        <span class="timeline-separator">•</span>
                                        <span class="timeline-author">{{action.CreatedByName}}</span>
                                        <span class="timeline-separator">•</span>
                                        <span class="timeline-type">{{action.ActionType}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks Tab -->
                    <div v-if="activeProfileTab === 'tasks'" class="profile-tab-panel">
                        <div class="tab-actions">
                            <button type="button" @click="toggleTaskForm" class="btn-modern btn-primary">
                                <span class="action-icon">📋</span> Assign Task
                            </button>
                        </div>

                        <!-- Task Form -->
                        <div v-if="showTaskForm" class="form-section">
                            <h4>Assign Task</h4>
                            <div class="form-group">
                                <label>Task Title <span class="required">*</span></label>
                                <input type="text" v-model="taskForm.taskTitle" class="form-control" placeholder="What needs to be done?">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea v-model="taskForm.taskDescription" class="form-control" rows="3" placeholder="Task details and instructions"></textarea>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Assign To <span class="required">*</span></label>
                                    <select v-model="taskForm.assignedToUserId" class="form-control">
                                        <option :value="null">Select Manager</option>
                                        <option v-for="manager in managers" :key="manager.userId" :value="manager.userId">
                                            {{manager.displayName}}
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Due Date</label>
                                    <input type="date" v-model="taskForm.dueDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select v-model="taskForm.priority" class="form-control">
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" @click="saveTask" class="btn-modern btn-primary">Assign Task</button>
                                <button type="button" @click="toggleTaskForm" class="btn-modern btn-secondary">Cancel</button>
                            </div>
                        </div>

                        <!-- Tasks List -->
                        <div v-if="profileData.tasks.length === 0" class="empty-state">
                            <div class="empty-icon">📋</div>
                            <h4>No Tasks Assigned</h4>
                            <p>No tasks have been assigned for this service provider yet.</p>
                        </div>
                        <div v-else class="tasks-grid">
                            <div v-for="task in profileData.tasks" :key="task.TaskID" class="task-card">
                                <div class="task-header">
                                    <h5>{{task.TaskTitle}}</h5>
                                    <button type="button" 
                                            @click="updateTaskStatus(task)"
                                            :class="['task-status-badge', getTaskStatusClass(task.Status)]">
                                        {{task.Status}}
                                    </button>
                                </div>
                                <p v-if="task.TaskDescription" class="task-description">{{task.TaskDescription}}</p>
                                <div class="task-meta-grid">
                                    <div class="task-meta-item">
                                        <label>Assigned to:</label>
                                        <span>{{task.AssignedToName}}</span>
                                    </div>
                                    <div class="task-meta-item" v-if="task.DueDate">
                                        <label>Due Date:</label>
                                        <span class="task-due">{{formatDate(task.DueDate)}}</span>
                                    </div>
                                    <div class="task-meta-item">
                                        <label>Priority:</label>
                                        <span :class="['priority-badge', getPriorityClass(task.Priority)]">{{task.Priority}}</span>
                                    </div>
                                    <div class="task-meta-item">
                                        <label>Created:</label>
                                        <span>{{formatDate(task.CreatedDate)}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Projects Tab - UPDATED LAYOUT -->
                    <div v-if="activeProfileTab === 'projects'" class="profile-tab-panel">
                        <div v-if="profileData.projects.length === 0" class="empty-state">
                            <div class="empty-icon">💼</div>
                            <h4>No Projects</h4>
                            <p>This service provider hasn't bid on any projects yet.</p>
                        </div>
                        <div v-else class="projects-grid">
                            <div v-for="project in profileData.projects" 
                                 :key="project.ProjectID" 
                                 :class="['project-card', { 'project-won': isProjectWon(project) }]">
            
                                <!-- Project Header -->
                                <div class="project-header">
                                    <div class="project-title-section">
                                        <a :href="'/projects/' + project.ProjectID" 
                                           target="_blank" 
                                           class="project-title-link">
                                            <h5>{{project.Title}}</h5>
                                        </a>
                                        <div class="project-id">ID: {{project.ProjectID}}</div>
                                    </div>
                                    <span v-if="project.OfferStatus" 
                                          :class="['project-status-badge', 'status-' + project.OfferStatus.toLowerCase()]">
                                        {{project.OfferStatus}}
                                    </span>
                                </div>

                                <!-- Project Description -->
                                <div v-if="project.Description" class="project-description">
                                    <label>Description:</label>
                                    <div class="project-description-content" 
                                         v-html="truncateHtml(project.Description, 150)"
                                         :title="project.Description">
                                    </div>
                                    <button v-if="project.Description.length > 150" 
                                            type="button" 
                                            @click="toggleProjectDescription(project.ProjectID)"
                                            class="show-more-btn">
                                        {{expandedProjects[project.ProjectID] ? 'Show Less' : 'Show More'}}
                                    </button>
                                    <div v-if="expandedProjects[project.ProjectID]" 
                                         class="project-description-full" 
                                         v-html="project.Description">
                                    </div>
                                </div>

                                <!-- Project Financial Info -->
                                <div class="project-financial-grid">
                                    <div v-if="project.Budget" class="financial-info-item">
                                        <label>Project Budget:</label>
                                        <span class="amount-display budget-amount">
                                            {{project.BudgetCur || 'EUR'}} {{formatNumber(project.Budget)}}
                                        </span>
                                    </div>
                                    <div v-if="project.OfferPrice" class="financial-info-item">
                                        <label>Our Offer:</label>
                                        <span class="amount-display offer-amount">
                                            {{project.OfferCurrency || 'EUR'}} {{formatNumber(project.OfferPrice)}}
                                        </span>
                                    </div>
                                </div>

                                <!-- Project Timeline -->
                                <div class="project-timeline-grid">
                                    <div class="timeline-info-item">
                                        <label>Project Created:</label>
                                        <span>{{formatDate(project.DateCreated)}}</span>
                                    </div>
                                    <div v-if="project.DateOffered" class="timeline-info-item">
                                        <label>Offer Submitted:</label>
                                        <span>{{formatDate(project.DateOffered)}}</span>
                                    </div>
                                </div>

                                <!-- Offer Message -->
                                <div v-if="project.OfferMessage" class="project-offer-message">
                                    <label>Offer Message:</label>
                                    <div class="offer-message-content">{{project.OfferMessage}}</div>
                                </div>

                                <!-- Project Footer with Status -->
                                <div class="project-footer">
                                    <div class="project-status-info">
                                        <span class="status-label">Status:</span>
                                        <span :class="['status-text', 'status-text-' + project.OfferStatus.toLowerCase()]">
                                            {{project.OfferStatus}}
                                        </span>
                                    </div>
                                    <div v-if="isProjectWon(project)" class="project-won-indicator">
                                        <span class="won-badge">🏆 Won</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ratings Tab -->
                    <div v-if="activeProfileTab === 'ratings'" class="profile-tab-panel">
                        <div class="tab-actions">
                            <button type="button" @click="toggleRatingForm" class="btn-modern btn-primary">
                                <span class="action-icon">⭐</span> Add Rating
                            </button>
                        </div>

                        <!-- Rating Form -->
                        <div v-if="showRatingForm" class="form-section">
                            <h4>Add Rating</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Category</label>
                                    <select v-model="ratingForm.ratingCategory" class="form-control">
                                        <option value="Overall">Overall</option>
                                        <option value="Communication">Communication</option>
                                        <option value="Quality">Quality</option>
                                        <option value="Reliability">Reliability</option>
                                        <option value="Professionalism">Professionalism</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Rating</label>
                                    <div class="rating-selector">
                                        <span v-for="n in 5" :key="n" 
                                              @click="ratingForm.rating = n" 
                                              :class="['rating-star', { 'active': n <= ratingForm.rating }]">
                                            {{n <= ratingForm.rating ? '★' : '☆'}}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Comments</label>
                                <textarea v-model="ratingForm.comments" class="form-control" rows="3" placeholder="Additional comments about this rating"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" @click="saveRating" class="btn-modern btn-primary">Save Rating</button>
                                <button type="button" @click="toggleRatingForm" class="btn-modern btn-secondary">Cancel</button>
                            </div>
                        </div>

                        <!-- Ratings List -->
                        <div v-if="profileData.ratings.length === 0" class="empty-state">
                            <div class="empty-icon">⭐</div>
                            <h4>No Ratings Yet</h4>
                            <p>No ratings have been recorded for this service provider.</p>
                        </div>
                        <div v-else class="ratings-grid">
                            <div v-for="rating in profileData.ratings" :key="rating.RatingID" class="rating-card">
                                <div class="rating-header">
                                    <div class="rating-category">{{rating.RatingCategory}}</div>
                                    <div class="rating-stars-large">{{formatRatingStars(rating.Rating)}}</div>
                                </div>
                                <p v-if="rating.Comments" class="rating-comments">{{rating.Comments}}</p>
                                <div class="rating-meta">
                                    <span>{{formatDate(rating.RatedDate)}}</span>
                                    <span class="rating-separator">•</span>
                                    <span>Rated by {{rating.RatedByName}}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Data Tab -->
                    <div v-if="activeProfileTab === 'profile'" class="profile-tab-panel">
                        <div class="profile-data-sections">
                            <!-- Company Information -->
                            <div class="profile-section">
                                <h3>Company Information</h3>
                                <div class="profile-info-grid">
                                    <div class="info-item" v-if="selectedProfile.CompanyName">
                                        <label>Company Name:</label>
                                        <span>{{selectedProfile.CompanyName}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.CompanyNumber">
                                        <label>Company Number:</label>
                                        <span>{{selectedProfile.CompanyNumber}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.CompanyType">
                                        <label>Company Type:</label>
                                        <span>{{selectedProfile.CompanyType}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.CompanySize">
                                        <label>Company Size:</label>
                                        <span>{{selectedProfile.CompanySize}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.CompanyIndustry">
                                        <label>Industry:</label>
                                        <span>{{selectedProfile.CompanyIndustry}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.CompanyTurnover">
                                        <label>Annual Turnover:</label>
                                        <span>{{selectedProfile.CompanyTurnover}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.CompanyJurisdiction">
                                        <label>Jurisdiction:</label>
                                        <span>{{selectedProfile.CompanyJurisdiction}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.YearOfEstablishment">
                                        <label>Year Established:</label>
                                        <span>{{selectedProfile.YearOfEstablishment}}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Personal Information -->
                            <div class="profile-section">
                                <h3>Personal Information</h3>
                                <div class="profile-info-grid">
                                    <div class="info-item" v-if="selectedProfile.Prefix">
                                        <label>Prefix:</label>
                                        <span>{{selectedProfile.Prefix}}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>First Name:</label>
                                        <span>{{selectedProfile.FirstName}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.MiddleName">
                                        <label>Middle Name:</label>
                                        <span>{{selectedProfile.MiddleName}}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Last Name:</label>
                                        <span>{{selectedProfile.LastName}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.PositionInCompany">
                                        <label>Position:</label>
                                        <span>{{selectedProfile.PositionInCompany}}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <div class="profile-section">
                                <h3>Contact Information</h3>
                                <div class="profile-info-grid">
                                    <div class="info-item">
                                        <label>Email:</label>
                                        <span><a :href="'mailto:' + selectedProfile.Email">{{selectedProfile.Email}}</a></span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.Phone">
                                        <label>Telephone:</label>
                                        <span>{{selectedProfile.Phone}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.Mobile">
                                        <label>Mobile:</label>
                                        <span>{{selectedProfile.Mobile}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.Fax">
                                        <label>Fax:</label>
                                        <span>{{selectedProfile.Fax}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.Website">
                                        <label>Website:</label>
                                        <span><a :href="selectedProfile.Website" target="_blank">{{selectedProfile.Website}}</a></span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.Twitter">
                                        <label>Twitter:</label>
                                        <span>{{selectedProfile.Twitter}}</span>
                                    </div>
                                    <div class="info-item" v-if="selectedProfile.Skype">
                                        <label>Skype:</label>
                                        <span>{{selectedProfile.Skype}}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Information -->
                            <div class="profile-section" v-if="selectedProfile.Street || selectedProfile.City || selectedProfile.Country">
                                <h3>Address Information</h3>
                                <div class="address-block">
                                    <div v-if="selectedProfile.Street">{{selectedProfile.Street}}</div>
                                    <div v-if="selectedProfile.City || selectedProfile.StateRegion">
                                        {{selectedProfile.City}}<span v-if="selectedProfile.City && selectedProfile.StateRegion">, </span>{{selectedProfile.StateRegion}}
                                    </div>
                                    <div v-if="selectedProfile.PostalCode">{{selectedProfile.PostalCode}}</div>
                                    <div v-if="selectedProfile.Country">{{selectedProfile.Country}}</div>
                                </div>
                            </div>

                            <!-- Services & Business (Read-Only) -->
                            <div class="profile-section expertise-section" v-if="selectedProfile.OurServices || selectedProfile.AboutYourServices || selectedProfile.AboutUs">
                                <h3>Services & Expertise <span class="readonly-badge">Read Only</span></h3>
                                <div class="expertise-content">
                                    <div class="expertise-item" v-if="selectedProfile.OurServices">
                                        <label>Our Services:</label>
                                        <div class="expertise-text" v-html="selectedProfile.OurServices"></div>
                                    </div>
                                    <div class="expertise-item" v-if="selectedProfile.AboutYourServices">
                                        <label>About Your Services:</label>
                                        <div class="expertise-text" v-html="selectedProfile.AboutYourServices"></div>
                                    </div>
                                    <div class="expertise-item" v-if="selectedProfile.AboutUs">
                                        <label>About Us:</label>
                                        <div class="expertise-text" v-html="selectedProfile.AboutUs"></div>
                                    </div>
                                    <div class="expertise-item" v-if="selectedProfile.FeesStructure">
                                        <label>Fees Structure:</label>
                                        <div class="expertise-text" v-html="selectedProfile.FeesStructure"></div>
                                    </div>
                                    <div class="expertise-item" v-if="selectedProfile.Publications">
                                        <label>Publications:</label>
                                        <div class="expertise-text" v-html="selectedProfile.Publications"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Edit Profile Tab -->
                    <div v-if="activeProfileTab === 'edit'" class="profile-tab-panel">
                        <div class="form-section">
                            <h4>Edit User Profile</h4>
                            
                            <!-- Account Information -->
                            <h5>Account Information</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" :value="selectedProfile.Username" class="form-control" disabled>
                                </div>
                                <div class="form-group">
                                    <label>User ID</label>
                                    <input type="text" :value="selectedProfile.UserId" class="form-control" disabled>
                                </div>
                            </div>

                            <!-- Basic Information -->
                            <h5>Basic Information</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name</label>
                                    <input type="text" v-model="editForm.firstName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    <input type="text" v-model="editForm.lastName" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Display Name</label>
                                    <input type="text" v-model="editForm.displayName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Email <span class="sub-text">(Read-only)</span></label>
                                    <input type="email" v-model="editForm.email" class="form-control" readonly>
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <h5>Contact Information</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" v-model="editForm.phone" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Mobile</label>
                                    <input type="tel" v-model="editForm.mobile" class="form-control">
                                </div>
                            </div>

                            <!-- Address Information -->
                            <h5>Address Information</h5>
                            <div class="form-group full-width">
                                <label>Street Address</label>
                                <input type="text" v-model="editForm.street" class="form-control">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>City</label>
                                    <input type="text" v-model="editForm.city" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>State/Region</label>
                                    <input type="text" v-model="editForm.stateRegion" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Postal Code</label>
                                    <input type="text" v-model="editForm.postalCode" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Country</label>
                                    <input type="text" v-model="editForm.country" class="form-control">
                                </div>
                            </div>

                            <!-- Role Information -->
                            <h5>Role Information</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Role Start Date</label>
                                    <input type="text" :value="formatDate(selectedProfile.RoleStartDate)" class="form-control" disabled>
                                </div>
                                <div class="form-group">
                                    <label>Role Expiration Date</label>
                                    <input type="date" v-model="editForm.roleExpirationDate" class="form-control">
                                </div>
                            </div>

                            <!-- Account Status -->
                            <h5>Account Status</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" v-model="editForm.isAuthorized" class="form-checkbox">
                                        <span>User is Authorized</span>
                                    </label>
                                    <div class="form-help">Unauthorized users cannot access the portal</div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label danger">
                                        <input type="checkbox" v-model="editForm.isDeleted" class="form-checkbox">
                                        <span>Soft Delete User</span>
                                    </label>
                                    <div class="form-help danger">User will be marked as deleted but data retained</div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" @click="saveUserEditFromTab" :disabled="isLoading" class="btn-modern btn-primary">
                                    <span v-if="isLoading">Saving...</span>
                                    <span v-else>Save Changes</span>
                                </button>
                                <button type="button" @click="closeProfile" :disabled="isLoading" class="btn-modern btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Record Payment Tab -->
                    <div v-if="activeProfileTab === 'payments'" class="profile-tab-panel">
                        <div class="form-section">
                            <h4>Record Payment for {{selectedProfile.DisplayName}}</h4>
                            
                            <!-- Subscription Plans -->
                            <h5>Select Subscription Plan</h5>
                            <div class="plan-grid">
                                <div v-for="plan in subscriptionPlans" :key="plan.PlanID" 
                                     @click="selectPlan(plan)"
                                     :class="['plan-card', { 'selected': paymentForm.planId === plan.PlanID }]">
                                    <div class="plan-name">{{plan.PlanName}}</div>
                                    <div class="plan-amount">€{{plan.Amount}}</div>
                                    <div class="plan-duration">{{plan.DurationMonths}} months</div>
                                    <div v-if="plan.Description" class="plan-description">{{plan.Description}}</div>
                                </div>
                            </div>

                            <!-- Payment Details -->
                            <h5>Payment Details</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Payment Date</label>
                                    <input type="date" v-model="paymentForm.paymentDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Payment Method</label>
                                    <select v-model="paymentForm.paymentMethod" class="form-control">
                                        <option value="BankTransfer">Bank Transfer</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Online">Online</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Reference Number <span class="required">*</span></label>
                                    <input type="text" v-model="paymentForm.referenceNumber" class="form-control" 
                                           placeholder="Transaction ID or receipt number">
                                </div>
                                <div class="form-group">
                                    <label>Plan Amount (€)</label>
                                    <input type="number" v-model="paymentForm.amount" class="form-control" 
                                           :disabled="paymentForm.planId !== null" step="0.01" readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Discount (€)</label>
                                    <input type="number" v-model="paymentForm.discountAmount" 
                                           @input="calculateAmountPaid" class="form-control" 
                                           step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Amount Paid (€)</label>
                                    <input type="number" v-model="paymentForm.amountPaid" class="form-control" 
                                           step="0.01" readonly style="font-weight: bold; background-color: #f0f8ff;">
                                </div>
                            </div>

                            <!-- Subscription Period -->
                            <h5>Subscription Period</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Start Date</label>
                                    <input type="date" v-model="paymentForm.subscriptionStartDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>End Date</label>
                                    <input type="date" v-model="paymentForm.subscriptionEndDate" class="form-control" :disabled="!paymentForm.planId">
                                </div>
                            </div>

                            <div class="form-group full-width">
                                <label>Notes</label>
                                <textarea v-model="paymentForm.notes" class="form-control" rows="3" 
                                          placeholder="Additional notes about this payment"></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" @click="savePaymentFromTab" :disabled="isLoading" class="btn-modern btn-primary">
                                    <span v-if="isLoading">Recording...</span>
                                    <span v-else>Record Payment</span>
                                </button>
                                <button type="button" @click="closeProfile" :disabled="isLoading" class="btn-modern btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Payment History Tab -->
                    <div v-if="activeProfileTab === 'payment-history'" class="profile-tab-panel">
                        <div class="tab-actions">
                            <button type="button" @click="loadPaymentHistoryForTab" class="btn-modern btn-primary">
                                <span class="action-icon">🔄</span> Refresh History
                            </button>
                        </div>

                        <div v-if="paymentHistory.length === 0" class="empty-state">
                            <div class="empty-icon">📜</div>
                            <h4>No Payment History</h4>
                            <p>No payments have been recorded for this user yet.</p>
                        </div>
                        
                        <div v-else class="payment-history-section">
                            <div class="payment-history-table">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Plan</th>
                                            <th>Amount</th>
                                            <th>Discount</th>
                                            <th>Paid</th>
                                            <th>Period</th>
                                            <th>Method</th>
                                            <th>Ref</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="payment in paymentHistory" :key="payment.PaymentID">
                                            <td>{{formatDate(payment.PaymentDate)}}</td>
                                            <td>{{payment.PlanName || '-'}}</td>
                                            <td>{{formatCurrency(payment.Amount)}}</td>
                                            <td>{{formatCurrency(payment.DiscountAmount || 0)}}</td>
                                            <td style="font-weight: bold;">{{formatCurrency(payment.Amount - (payment.DiscountAmount || 0))}}</td>
                                            <td>
                                                <div v-if="payment.SubscriptionStartDate && payment.SubscriptionEndDate">
                                                    {{formatDate(payment.SubscriptionStartDate)}} - {{formatDate(payment.SubscriptionEndDate)}}
                                                </div>
                                                <span v-else>-</span>
                                            </td>
                                            <td>{{payment.PaymentMethod || '-'}}</td>
                                            <td>{{payment.ReferenceNumber || '-'}}</td>
                                            <td>
                                                <span :class="['payment-status', getPaymentStatusClass(payment.Status)]">
                                                    {{payment.Status}}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div v-if="editingUser" class="modal-overlay" @click.self="cancelEdit">
            <div class="modal-content modal-edit">
                <div class="modal-header">
                    <h3>Edit User: {{editingUser.DisplayName}}</h3>
                    <button type="button" class="modal-close" @click="cancelEdit">×</button>
                </div>
                
                <div class="modal-body">
                    <div class="edit-form">
                        <!-- Account Information -->
                        <h4>Account Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" :value="editingUser.Username" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label>User ID</label>
                                <input type="text" :value="editingUser.UserId" class="form-control" disabled>
                            </div>
                        </div>

                        <!-- Basic Information -->
                        <h4>Basic Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" v-model="editForm.firstName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" v-model="editForm.lastName" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" v-model="editForm.displayName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Email <span class="sub-text">(Read-only)</span></label>
                                <input type="email" v-model="editForm.email" class="form-control" readonly title="Email cannot be changed from this interface">
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <h4>Contact Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" v-model="editForm.phone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Mobile</label>
                                <input type="tel" v-model="editForm.mobile" class="form-control">
                            </div>
                        </div>

                        <!-- Address Information -->
                        <h4>Address Information</h4>
                        <div class="form-group full-width">
                            <label>Street Address</label>
                            <input type="text" v-model="editForm.street" class="form-control">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" v-model="editForm.city" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>State/Region</label>
                                <input type="text" v-model="editForm.stateRegion" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Postal Code</label>
                                <input type="text" v-model="editForm.postalCode" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <input type="text" v-model="editForm.country" class="form-control">
                            </div>
                        </div>

                        <!-- Role Information -->
                        <h4>Role Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Role Start Date</label>
                                <input type="text" :value="formatDate(editingUser.RoleStartDate)" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label>Role Expiration Date</label>
                                <input type="date" v-model="editForm.roleExpirationDate" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Current Status</label>
                                <input type="text" :value="getStatus(editingUser)" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label>Current Plan</label>
                                <input type="text" :value="editingUser.CurrentPlan || 'None'" class="form-control" disabled>
                            </div>
                        </div>

                        <!-- Account Status -->
                        <h4>Account Status</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" 
                                           v-model="editForm.isAuthorized" 
                                           class="form-checkbox">
                                    <span>User is Authorized</span>
                                </label>
                                <div class="form-help">Unauthorized users cannot access the portal</div>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label danger">
                                    <input type="checkbox" 
                                           v-model="editForm.isDeleted" 
                                           class="form-checkbox">
                                    <span>Soft Delete User</span>
                                </label>
                                <div class="form-help danger">User will be marked as deleted but data retained</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" @click="saveUserEdit" class="btn-modern btn-primary">Save Changes</button>
                    <button type="button" @click="cancelEdit" class="btn-modern btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div v-if="showConfirmModal" class="modal-overlay" @click="cancelRemove">
            <div class="modal-content" @click.stop>
                <h3>Confirm Removal</h3>
                <p>Are you sure you want to remove <strong>{{userToRemove.DisplayName}}</strong> from the Service Provider role?</p>
                <div class="modal-actions">
                    <button type="button" @click="removeUser" class="btn-modern btn-danger">Yes, Remove</button>
                    <button type="button" @click="cancelRemove" class="btn-modern btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div v-if="showPaymentModal" class="modal-overlay" @click="cancelPayment">
            <div class="modal-content modal-payment" @click.stop>
                <div class="modal-header">
                    <h3>Record Payment for {{paymentForm.userName}}</h3>
                    <button type="button" class="modal-close" @click="cancelPayment">×</button>
                </div>
                
                <div class="modal-body">
                    <!-- Subscription Plans -->
                    <h4>Select Subscription Plan</h4>
                    <div class="plan-grid">
                        <div v-for="plan in subscriptionPlans" :key="plan.PlanID" 
                             @click="selectPlan(plan)"
                             :class="['plan-card', { 'selected': paymentForm.planId === plan.PlanID }]">
                            <div class="plan-name">{{plan.PlanName}}</div>
                            <div class="plan-amount">€{{plan.Amount}}</div>
                            <div class="plan-duration">{{plan.DurationMonths}} months</div>
                            <div v-if="plan.Description" class="plan-description">{{plan.Description}}</div>
                        </div>
                    </div>

                    <!-- Payment Details -->
                    <h4>Payment Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Date</label>
                            <input type="date" v-model="paymentForm.paymentDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select v-model="paymentForm.paymentMethod" class="form-control">
                                <option value="BankTransfer">Bank Transfer</option>
                                <option value="Cash">Cash</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Reference Number <span class="required">*</span></label>
                            <input type="text" v-model="paymentForm.referenceNumber" class="form-control" 
                                   placeholder="Transaction ID or receipt number">
                        </div>
                        <div class="form-group">
                            <label>Plan Amount (€)</label>
                            <input type="number" v-model="paymentForm.amount" class="form-control" 
                                   :disabled="paymentForm.planId !== null" step="0.01" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Discount (€)</label>
                            <input type="number" v-model="paymentForm.discountAmount" 
                                   @input="calculateAmountPaid" class="form-control" 
                                   step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>Amount Paid (€)</label>
                            <input type="number" v-model="paymentForm.amountPaid" class="form-control" 
                                   step="0.01" readonly style="font-weight: bold; background-color: #f0f8ff;">
                        </div>
                    </div>

                    <!-- Subscription Period -->
                    <h4>Subscription Period</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" v-model="paymentForm.subscriptionStartDate" 
                                   @change="paymentForm.planId && selectPlan(subscriptionPlans.find(p => p.PlanID === paymentForm.planId))"
                                   class="form-control">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" v-model="paymentForm.subscriptionEndDate" 
                                   class="form-control" :disabled="!paymentForm.planId">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label>Notes</label>
                        <textarea v-model="paymentForm.notes" class="form-control" rows="3" 
                                  placeholder="Additional notes about this payment"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" @click="savePayment" class="btn-modern btn-primary">Record Payment</button>
                    <button type="button" @click="cancelPayment" class="btn-modern btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Payment History Modal -->
        <div v-if="showPaymentHistoryModal" class="modal-overlay" @click="closePaymentHistory">
            <div class="modal-content modal-history" @click.stop>
                <div class="modal-header">
                    <h3>Payment History - {{viewingPaymentHistoryUser ? viewingPaymentHistoryUser.DisplayName : ''}}</h3>
                    <button type="button" class="modal-close" @click="closePaymentHistory">×</button>
                </div>
                
                <div class="modal-body">
                    <div v-if="paymentHistory.length === 0" class="no-payments">
                        No payments recorded for this user.
                    </div>
                    
                    <div v-else class="payment-history-table">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Plan</th>
                                    <th>Amount</th>
                                    <th>Discount</th>
                                    <th>Paid</th>
                                    <th>Period</th>
                                    <th>Method</th>
                                    <th>Ref</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="payment in paymentHistory" :key="payment.PaymentID">
                                    <td>{{formatDate(payment.PaymentDate)}}</td>
                                    <td>{{payment.PlanName || '-'}}</td>
                                    <td>{{formatCurrency(payment.Amount)}}</td>
                                    <td>{{formatCurrency(payment.DiscountAmount || 0)}}</td>
                                    <td style="font-weight: bold;">{{formatCurrency(payment.Amount - (payment.DiscountAmount || 0))}}</td>
                                    <td>
                                        <div v-if="payment.SubscriptionStartDate && payment.SubscriptionEndDate">
                                            {{formatDate(payment.SubscriptionStartDate)}} - {{formatDate(payment.SubscriptionEndDate)}}
                                        </div>
                                        <span v-else>-</span>
                                    </td>
                                    <td>{{payment.PaymentMethod || '-'}}</td>
                                    <td>{{payment.ReferenceNumber || '-'}}</td>
                                    <td>
                                        <span :class="['payment-status', getPaymentStatusClass(payment.Status)]">
                                            {{payment.Status}}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" @click="closePaymentHistory" class="btn-modern btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>
</script>

<script language="javascript" type="text/javascript">
    jQuery(function () {
        var moduleId = parseInt("[ModuleContext:ModuleId]");

        var app = new Vue({
            data: {
                moduleId: moduleId
            },
            el: "#ServiceProvider-" + moduleId,
            components: {
                "service-provider-manager": FinHubAddOns.ServiceProviderComponent
            }
        });

        // Store Vue instance for debugging
        window['ServiceProviderApp_' + moduleId] = app;

        // Create global tooltip element
        if (!document.getElementById('global-tooltip')) {
            var tooltip = document.createElement('div');
            tooltip.id = 'global-tooltip';
            tooltip.className = 'custom-tooltip';
            document.body.appendChild(tooltip);
        }

        // Close action menus when clicking outside
        jQuery(document).on('click', function (e) {
            if (!jQuery(e.target).closest('.action-dropdown').length) {
                var vm = app.$children[0];
                if (vm) {
                    vm.actionMenuOpen = null;
                }
            }
        });
    });
</script>